<dom-module id="steem-get-followers"></dom-module>

<script src="./src/steem.min.js"></script>

<script>

    (function () {

        Polymer({

            is: 'steem-get-followers',

            properties: {

                /*
                 * Account name.
                 * f.e. "you"
                 * Component will query account data with this name.
                 */
                accountName:  {
                    type: String,
                    observer: '_accountNameChanged'
                },

                /*
                 * Followers array.
                 * Component will provide followers list in this array.
                 */
                followers: {
                    type: Array,
                    observer: '_followersChanged',
                    notify: true
                },

                _lastFollowerLoaded: {
                    type: String
                }
            },

            ready: function() {

                // Set default value
                if(typeof this.accountName === 'undefined') { this.accountName = '';}
                this._lastFollowerLoaded = '';

            },

            _accountNameChanged: function() { // When account change

                if(this.accountName !== ''){

                    this.followers = []; // Reset followers
                    this._loadFollower(); // Start loading

                }
            },

            _followersChanged: function() { // load more followers if needed

                if(typeof this.followers !== 'undefined') {

                    if(this.followers.length > 0) {

                        var followerLength = this.followers.length;

                        // Load more ?
                        var followerMultipleOf100 = (followerLength/100 == Math.floor(followerLength/100));
                        var loadMore = (this.followers.length >= 100 && followerMultipleOf100);

                        if(loadMore == true) {

                            this._loadFollower();
                            console.log("LOAD MORE");
                        }
                    }
                }

            },

            _loadFollower: function() {
                console.log("LOAD More");

                var thisElement = this;
                var actualFollowers = this.followers || [];

                // Query followers
                this.async(function () {

                    console.log('loadedFrom='+thisElement._lastFollowerLoaded);
                    // !!! Need api to provide load more than 100 followers to load full list
                    steem.api.getFollowers(thisElement.accountName, thisElement._lastFollowerLoaded, null, 100, function (err, result) {

                        var followers = [];

                        if (!err) {

                            for (var i = 0; i < result.length; i++) {

                                // Process user
                                var user = result[i].follower;

                                // Push received user in followers
                                followers.push(user);

                            }
                        }

                        if(typeof thisElement.followers === 'undefined') {
                            console.log("Reset follower");
                            thisElement.followers = [];
                        }

                        // Get the last follower of the list for the next query
                        thisElement.set('_lastFollowerLoaded', followers[followers.length -1]);
                        // Add followers queried
                        thisElement.set('followers', thisElement.followers.concat(followers));
                    });

                });


            }
        });
    })();
</script>