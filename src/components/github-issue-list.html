<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">


<link rel="import" href="../api/github/get-repository-issues.html">
<link rel="import" href="../api/github/get-repository-milestones.html">
<link rel="import" href="../api/github/get-repository-labels.html">
<link rel="import" href="../components/my-icons.html">
<link rel="import" href="../shared-styles.html">
<dom-module id="github-issue-list">

    <template>

        <style include="shared-styles">

            #issueFilter {
                padding-left: 16px;
                padding-right: 16px;
                border: 1px solid var(--app-background-primary-text-color);
            }
            
            #issueFilter paper-menu-button {
                float: right;
                margin-top: 4px;
            }

            paper-listbox {
                --paper-listbox-background-color: transparent;
                --paper-listbox-color: inerhite;
                border-left: 1px solid var(--app-background-secondary-text-color);
                border-right: 1px solid var(--app-background-secondary-text-color);
                color: var(--app-background-primary-text-color);
            }

            iron-icon {
                color: var(--app-background-secondary-text-color);
                margin-right: 12px;
            }

            paper-progress {
                --paper-progress-active-color: var(--app-primary-color);
                --paper-progress-secondary-color: var(--app-secondary-color);
                width: 100%;
            }

            .clearSelectedMilestone {
                display: inline-block;
            }


        </style>

        <get-repository-issues repository="[[repository]]"
                               milestone="[[_selectedMilestoneNumber]]"
                               labels="[[_selectedLabels]]"
                               issue-type="[[_selectedIssueType]]"
                               issues="{{_issues}}">
        </get-repository-issues>

        <get-repository-milestones repository="[[repository]]"
                                   milestones="{{_milestones}}">
        </get-repository-milestones>

        <get-repository-labels repository="[[repository]]"
                               labels="{{_labels}}">
        </get-repository-labels>

        <div id="issueFilter">
            <paper-dropdown-menu label="Project"
                                 selected-item-label="{{_selectedMilestone}}"
                                 horizontal-align="left">
                <paper-listbox class="dropdown-content">

                    <paper-icon-item label="None">

                        <iron-icon icon="my-icons:close"
                                   item-icon>
                        </iron-icon>

                        <paper-item-body>
                            <div>None</div>
                        </paper-item-body>

                    </paper-icon-item>

                    <template is="dom-repeat" items="[[_milestones]]">

                        <paper-icon-item label="[[item.title]]">

                            <iron-icon icon="my-icons:milestone-[[item.state]]"
                                       item-icon>
                            </iron-icon>

                            <paper-item-body two-line>
                                <div>[[item.title]] ([[item.closed_issues]]/[[_computeTotalIssues(item.open_issues, item.closed_issues)]])</div>
                                <div secondary>[[item.description]] [[[_timeFromNow(item.created_at)]] by [[item.creator.login]]]</div>
                            </paper-item-body>

                        </paper-icon-item>

                        <paper-progress value="[[_computeMilestoneProgress(item.closed_issues, item.open_issues)]]"
                                        secondary-progress="100">
                        </paper-progress>

                    </template>
                </paper-listbox>
            </paper-dropdown-menu>

            <paper-menu-button id="selectTagMenuButton"
                               ignore-select
                               horizontal-align="right">

                <paper-icon-button icon="my-icons:label" class="dropdown-trigger"></paper-icon-button>

                <paper-menu id="selectTagMenu"
                            class="dropdown-content">
                    <template is="dom-repeat"
                              items="[[_labels]]">
                        <paper-item>
                            <paper-checkbox checked="{{item.selected}}">
                                [[item.name]]
                            </paper-checkbox>
                        </paper-item>
                    </template>
                </paper-menu>
            </paper-menu-button>

        </div>

        <div id="issueList">
            <paper-tabs selected="{{_selectedIssueType}}"
                        attr-for-selected="issuetype">
                <paper-tab issuetype="open">Open</paper-tab>
                <paper-tab issuetype="closed">Closed</paper-tab>
            </paper-tabs>

        </div>

        <paper-listbox>

            <template is="dom-repeat"
                      items="[[_issues]]">
                [[item]]
            </template>

        </paper-listbox>

    </template>

    <script>

        (function() {

            'use strict';

            Polymer({

                is: 'github-issue-list',

                behaviors: [
                    Polymer.AppLocalizeBehavior
                ],

                properties: {

                    /*
                     * files array
                     */
                    repository: {
                        type: String
                    },

                    _issues: {
                        type: Array
                    },

                    _labels: {
                        type: Array
                    },

                    _selectedLabels: {
                        type: String
                    },

                    _milestones: {
                        type: Array
                    },

                    _selectedMilestone: {
                        type: String
                    },

                    _selectedMilestoneNumber: {
                        type: String
                    },

                    _selectedIssueType: {
                        type: String
                    }
                },

                observers: [
                    '_selectedMilestoneChanged(_selectedMilestone)',
                    '_labelsChanged(_labels)'
                ],

                listeners: {
                    'selectTagMenu.tap': '_labelsChanged'
                },

                ready: function() {

                    // Set default values
                    this._selectedMilestone = 'None';
                    this._selectedLabels = '';
                    this._selectedIssueType = 'open';
                },

                _timeFromNow: function(date) {

                    return new IntlRelativeFormat('en-us').format(new Date(date));
                },

                _computeTotalIssues: function(open, closed) {

                    return (open + closed);
                },


                _labelsChanged: function() {
                    console.log("Labels taped");
                    var length = this._labels.length;
                    var selectedLabels = [];

                    for(var i = 0; i < length;i++) {

                        if(typeof this._labels[i].selected !== 'undefined') {

                            var label = this._labels[i];

                            if(label.selected){

                                selectedLabels.push(label.name);
                            }
                        }
                    }

                    if(selectedLabels.length) {
                        // Github API need a string where label are separated by ','
                        this._selectedLabels = selectedLabels.join(',');
                        console.log(this._selectedLabels);
                    }

                },

                _selectedMilestoneChanged: function(_selectedMilestone) {

                    console.log(_selectedMilestone);

                    if(_selectedMilestone.toLowerCase() == 'none') {

                        this._selectedMilestoneNumber = 'none';
                    }else {

                        this._selectedMilestoneNumber = this._getMilestoneNumberByTitle(_selectedMilestone);
                    }
                },

                _computeMilestoneProgress: function(closed, open) {

                    if(closed == 0) {

                        return '0';
                    }

                    if(open == 0) {

                        return '100';
                    }

                    var total = open + closed;
                    var ratio = (closed / total) * 100 ; // on 100
                    return Math.round(ratio);
                },

                _clearSelectedMilestone: function() {

                    this._selectedMilestone = '';
                },

                _getMilestoneNumberByTitle: function(title) {

                    if(typeof this._milestones !== 'undefined') {

                        var milestones = this._milestones;
                        var length = milestones.length;

                        for(var i = 0; i < length; i++) {

                            var milestone = milestones[i];

                            if(milestone.title == title) {

                                return milestone.number;
                            }
                        }
                    }
                }

                // API https://developer.github.com/v3/issues/#list-issues-for-a-repository
                //https://developer.github.com/v3/issues/
            });
        })();
    </script>
</dom-module>