<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/marked-element/marked-element.html">

<link rel="import" href="post-wrapper.html">
<link rel="import" href="post-path-list.html">
<link rel="import" href="github-repository.html">
<link rel="import" href="github-repository-file-view.html">
<link rel="import" href="google-docs-embedded.html">

<dom-module id="html-echo">
    <style>

        /* GENERAL */
        :host {
            display: block;
        }

        ::selection {
            background: var(--app-light-primary-color);
            color: var(--app-primary-text-color);
        }

        .markdown-html .primary-color {
            color: var(--app-primary-color);
        }

        .markdown-html .secondary-color {
            color: var(--app-secondary-color);
        }

        .markdown-html .bold {
            font-weight: bold;
        }

        .markdown-html .low-priority {
            color: #8BC34A;
        }

        .markdown-html .medium-priority {
            color: #FFEB3B;
        }

        .markdown-html .high-priority {
            color: #FF5722;
        }

        .markdown-html .bold {
            font-weight: bold;
        }

        .markdown-html .bold {
            font-weight: bold;
        }

        .markdown-html blockquote {
            margin-left: 0;
            margin-right: 0;
            padding-left: 32px;
            border-left: solid 3px var(--app-background-secondary-text-color);
        }


        /* BASIC */
        .markdown-html a {
            color: var(--app-secondary-color) !important;
        }

        .markdown-html * {
            font-family: 'Open Sans', 'Roboto', sans-serif;
        }

        .markdown-html h1, .markdown-html h2, .markdown-html h3, .markdown-html h4, .markdown-html h5, .markdown-html h6 {
            color: var(--app-background-primary-text-color);
            font-family: 'Roboto', 'Open Sans', sans-serif;
        }

        .markdown-html img {
            max-width: 100%;
        }

        /* TABLES */
        .markdown-html table {
            max-width: 100%;
            border-collapse: collapse;
            overflow: scroll;
        }

        .markdown-html table, .markdown-html th, .markdown-html td {
            border: 1px solid #ddd;
        }

        .markdown-html th, .markdown-html td {
            padding: 8px;
        }

        .markdown-html th a, .markdown-html td a {
            text-decoration: none;
        }

        .markdown-html th:hover, .markdown-html td:hover {
            background-color: #888;
        }

        .markdown-html th {
            font-weight: bold;
        }

        .markdown-html tr:hover {
            background-color: #777;
        }

        /* APP Elements */
        .markdown-html post-path-list {
            width: 100%;
        }

        .markdown-html post-wrapper {
            width: 100%;
        }

    </style>
    <template>
        <marked-element markdown="[[_htmlDisplayed]]">
            <div class="markdown-html">[[_htmlDisplayed]]</div>
        </marked-element>
    </template>
</dom-module>

<script>

    (function () {

        Polymer({

            is: 'html-echo',

            properties: {

                html: {
                    type: String,
                    observer: '_htmlChanged'
                },

                _htmlDisplayed: {
                    type: String
                }
            },

            ready: function() {

            },

            _htmlChanged: function () {

                var html = this.html;

                if(html.includes('â€• Leonardo da Vinci')){

                    //html += ' created/esteem8-features ';
                    html += ' https://github.com/esteem8app/esteem8app.github.io ';
                    //html += '  https://github.com/esteem8app/esteem8app.github.io/blob/master/src/scripts/intl-relativeformat-with-locales.min.js ';
                    //html += ' steem/@esteem8/esteem8-community-proposals ';
                    //html += ' steem/@primerz/what-is-steem ';
                    //html += ' https://www.youtube.com/watch?v=QdPivOm-gWc ';
                    //html += ' https://www.youtube.com/watch?v=QdPivOm-gWc '
                    //html += ' https://docs.google.com/document/d/1egC37b1veO5nXPmdpAGI0blNOxL9OQaGqNz8lKQp9os/edit  https://docs.google.com/spreadsheets/d/1jdugr0kNcXRrBsGh7u9mETp5oc06aILkihtq9Lg-vGY/edit ';
                    //html += ' [iframe$ratio=1:3&url=https://primerz.github.io/] ';
                    //html += ' https://soundcloud.com/ltj-bukem/ltj-bukem-return-to-atlantis ';
                }

                if(html.includes('You can create your own idea')) {

                    //html += ' https://github.com/esteem8app/esteem8app.github.io ';
                }

                // RENDER <a href into <img>
                var imageLinkARegex = /<a([ ="'a-zA-Z0-9-]+)? href=('|")(https?:\/\/)?(\w+.)?\w+.\w+[ \/%&a-zA-Z0-9-]+.(jpg|png|gif|jpeg)\??([ \/%&=a-zA-Z0-9-]+)?("|')>(https?:\/\/)?(\w+.)?\w+.\w+[ \/%&a-zA-Z0-9-]+.(jpg|png|gif|jpeg)\??([ \/%&=a-zA-Z0-9-]+)?<\/a>/gm;
                html = html.replace(imageLinkARegex, function(match){

                    var imgUrlRegex = /(https?:\/\/)?(\w+.)?\w+.\w+[ \/%&a-zA-Z0-9-]+.(jpg|png|gif|jpeg)\??([ \/%&=a-zA-Z0-9-]+)?/g;
                    var url = imgUrlRegex.exec(match)[0];

                    return '<img src="' + url + '" ></img>';
                });

                // RENDER ![](src) & [](src) into <img>
                var markdwonImageRegex = /!?\([ a-zA-Z0-9-]+\)!?\[(https?:\/\/)?(\w+.)?\w+.\w+[ \/%&a-zA-Z0-9-]+.(jpg|png|gif|jpeg)\??([ \/%&=a-zA-Z0-9-]+)?]/gm;
                html = html.replace(markdwonImageRegex, function(match){

                    var imgUrlRegex = /(https?:\/\/)?(\w+.)?\w+.\w+[ \/%&a-zA-Z0-9-]+.(jpg|png|gif|jpeg)\??([ \/%&=a-zA-Z0-9-]+)?/g;
                    var url = imgUrlRegex.exec(match)[0];

                    return '<img src="' + url + '" ></img>';
                });


                var commentProjectElement = /(\[((objectives?|composition|strategy|strategies|projects?|tasks?)]))/gm;
                html = html.replace(commentProjectElement, function(match){

                    return '<span class="primary-color">' + match + '</span>';
                });

                var postPriorityElement = /(\[(?:very )?(low|medium|high) (priority)\])/gm;
                html = html.replace(postPriorityElement, function(match){

                    var priorityColorRegex = /((low|medium|high) priority)/g;
                    var priorityColor = imgUrlRegex.exec(match)[0];
                    priorityColor = priorityColor.replace(" ", "-");

                    return '<span class="' + priorityColor + '">' + match + '</span>';
                });


                // RENDER direct image link into <img> (must not be yet in <img>)

                /* RENDER in-app elements from link*/

                // Tag path -> <post-path-list>
                /*var tagPathRegex = /[^("|'|[)](created|hot|trending|active)\/[a-zA-Z0-9-]+/gm;
                 html = html.replace(tagPathRegex, function(match){

                 var match = match.replace(" ", "");
                 console.log(match);
                 return '<post-path-list steem-path="' + match + '" post-type="card-light"></post-path-list>';
                 });

                 // User path -> <post-path-list>
                 var tagPathRegex = /[^(\/|"|'|[)]\/@[a-zA-Z0-9-]+/gm;
                 html = html.replace(tagPathRegex, function(match){

                 var match = match.replace(" ", "");
                 return '<post-path-list steem-path="' + match + '" post-type="card-light"></post-path-list>';
                 });
                 */
                // Post path -> <post>
                var postPathRegex = /[^("|'|\[)](\/)?[a-zA-Z0-9-]+\/@[a-zA-Z0-9-]+\/[a-zA-Z0-9-]+/gm;
                html = html.replace(postPathRegex, function(match){

                    var match = match.replace(/ /g, "");
                    return '<post-wrapper steem-path="' + match + '" post-type="content-minimal"></post-wrapper>';
                });

                // Github repository path -> <github-repository>
                var gitHubRepositoryRegex = /[^("|'|[)]https:\/\/github\.com\/[a-zA-Z0-9-]+\/[a-zA-Z0-9-]+\.[a-zA-Z0-9-]+\.[a-zA-Z0-9-]+ /gm
                html = html.replace(gitHubRepositoryRegex, function(match){

                    var match = match.replace(/ /g, "");
                    return '<github-repository repository="' + match + '" ></github-repository>';
                });

                // Github file view -> <github-repository-file-view>
                var gitHubRepositoryFileRegex = /[^("|'|\[)](https:\/\/github.com\/\w+\/([\.a-zA-Z0-9]+)\/blob\/\w+\/[\.\/a-zA-Z0-9-]+)/gm
                html = html.replace(gitHubRepositoryFileRegex, function(match){

                    var match = match.replace(/ /g, "");
                    return '<github-repository-file-view file-url="' + match + '" ></github-repository-file-view>';
                });

                // Consider it link -> <responsive-iframe>
                var considerItRegex = /[^("|'|[)]https:\/\/[a-zA-Z0-9-]+\.[a-zA-Z0-9-]+\.it\//gm;
                html = html.replace(considerItRegex, function(match){

                    var url = match.replace(/ /g, "");
                    return '<responsive-iframe url="' + url + '" ></responsive-iframe>';
                });

                // Youtube video
                var youtubeVideoregex = /[^("|'|[)]https:\/\/www\.[a-zA-Z0-9-]+\.com\/(watch\?v=|embed\/)[_a-zA-Z0-9-]+/gm
                html = html.replace(youtubeVideoregex, function(match){

                    var match = match.replace(/ /g, "");
                    var url = match.replace("https://www.youtube.com/watch?v=", "https://www.youtube.com/embed/");

                    return '<responsive-iframe url="' + url + '" ></responsive-iframe>';
                });

                // Soundcloud track + maybe other soundcloud elements
                var soundcloudSoundRegex = /https:\/\/soundcloud.com\/[a-zA-Z0-9-]*\/[a-zA-Z0-9-?=\/]*/gm;
                html = html.replace(soundcloudSoundRegex, function(match){

                    var match = match.replace(/ /g, "");
                    var url = 'https://w.soundcloud.com/player/?url=' + match;

                    return '<responsive-iframe ratio="24:9" url="' + url + '" ></responsive-iframe>';
                });

                // PDF
                // https://customelements.io/streetturtle/pdf-element/

                // Google docs -> <google-docs-embedded>
                var googleDocsRegex = /[^("|'|[)]https:\/\/(docs|www)\.google\.com\/(presentation|document|spreadsheets|forms|drawings|maps)\/d\/(e\/)?(u\/)?(0\/)?[_?=\-.a-zA-Z0-9-]*\/[%\-.?&a-zA-Z0-9-#=]*/gm;
                html = html.replace(googleDocsRegex, function(match){

                    var match = match.replace(/ /g, "");
                    var url = '';

                    if(!match.includes('maps')) {

                        // Url can be one that is publicly published or one that we used in editor
                        var rawDocummentUrlRegex = /https:\/\/(docs|www)\.google\.com\/(presentation|document|spreadsheets|forms|drawings|maps)\/d\/(e\/)?[_?=\-.a-zA-Z0-9-]*\//g
                        url = rawDocummentUrlRegex.exec(match)[0];

                        if(url.includes('https://docs.google.com/presentation')) {

                            url += 'embed';
                        }

                        if(url.includes('https://docs.google.com/document')){

                            url += 'pub?embedded=true';
                        }

                        if(url.includes('https://docs.google.com/spreadsheets')) {

                            url += 'pubhtml';
                        }

                        if(url.includes('https://docs.google.com/forms')) {

                            url += 'viewform';
                        }

                        if(url.includes('https://docs.google.com/drawings')) {

                            url += 'pub';
                        }

                    }else if(match.includes('maps')) {

                        url = 'https://www.google.com/maps/d/u/0/embed?';

                        var rawMapUrlRegx = /mid=[_a-zA-Z0-9-]*/g;
                        var mid = rawMapUrlRegx.exec(match)[0];

                        url += mid;
                    }


                    return '<google-docs-embedded url="' + url + '" ></google-docs-embedded>';
                });

                // Google site
                var googleSiteRegex = /[^("|'|[)]https:\/\/sites\.google\.com\/view\/[_a-zA-Z0-9-]*\//gm;
                html = html.replace(googleSiteRegex, function(match) {

                    var url = match.replace(/ /g, "");

                    return '<responsive-iframe url="' + url + '" ratio="3:1" ></responsive-iframe>';
                });

                // Custom element ( [iframe$ratio=1:3&url=https://primerz.github.io/])
                var customElementRegex = /\[(iframe|steem tag)(\$)?([\/.=&:a-z0-9]+)?]/gm;
                html = html.replace(customElementRegex, function(match) {

                    var match = match.replace(/ /g, "");
                    var match = match.replace("[", "");
                    var match = match.replace("]", "");

                    var rawElement = match.split("$")[0];
                    var options = match.split("$")[1].split("&") || [];

                    var preDefinedAttributes = [];
                    var appElement = '';

                    // Get element type
                    switch (rawElement) {

                        case 'iframe':
                            appElement = 'responsive-iframe';
                            preDefinedAttributes.push(['prompt-user', 'true']);

                    }

                    //Add parameters (attribute and value)
                    var attributes = preDefinedAttributes; // Array of attributes & value

                    for(var i = 0; i < options.length;i++) {

                        var attribute = options[i].split('='); // [attribute, value]
                        attributes.push(attribute);

                    }

                    // Create html
                    var html = '<'+ appElement + ' ';

                    for (var i = 0; i < attributes.length; i++) {

                        html += attributes[i][0] + '="' + attributes[i][1] + '" ';
                    }

                    html += '></' + appElement + '>';

                    return html;
                });

                // REGEX tester https://regex101.com/

                this._htmlDisplayed = html;

                /* TODO
                 * [ ] implement set post type from link such as [$card-light:/path]
                 * [X] Render markdown as HTML
                 * [ ] transform links into HTML or Custom elements such as [$iframe:urlXYZ] || [$post.author] || [$button:value=follow [$post.author.account.field_signature] type=follow action=follow [$post.author]] or something easier that can work together with other CE maybe with html logic
                 * [ ] transform absolute url that can be used by the app into relative to make theme functional
                 * [ ] Sanitize HTML
                 */

                /*
                 * IDEAS
                 * Email form maybe with https://formspree.io
                 * Github HTML API file
                 * Github HTML API folder
                 * Github HTML API organization
                 * Github HTML API Account
                 * Github JS API implementation
                 * Raw video extraction from yt and + with custom video player found on customelement.io
                 * soundcloud JS API implementation https://developers.soundcloud.com/docs/api/guide
                 * Discord embedded on desktop or link on mobile
                 * Render code with prism render
                 */

            }
        });
    })();
</script>