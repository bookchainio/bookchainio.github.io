<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">

<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-menu/paper-submenu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../components/post-card-light.html">
<link rel="import" href="../components/post-card.html">
<link rel="import" href="../components/reply-card.html">
<link rel="import" href="../components/event-card.html">
<link rel="import" href="../components/user-card.html">
<link rel="import" href="../components/html-echo.html">
<link rel="import" href="../components/post-wrapper.html">
<link rel="import" href="../components/github-repository.html">

<link rel="import" href="../api/steemjs/steem-get-state.html">
<link rel="import" href="../api/steemjs/steem-get-post.html">
<link rel="import" href="../api/steemjs/steem-get-_account.html">
<link rel="import" href="../api/steemjs/steem-get-followers.html">
<link rel="import" href="../api/steemjs/steem-get-following.html">
<link rel="import" href="../api/steemjs/steem-get-replies.html">
<link rel="import" href="../api/steemjs/steem-get-history.html">

<link rel="import" href="../components/my-icons.html">

<link rel="import" href="../shared-styles.html">

<dom-module id="page-profile">

    <template>

        <style include="shared-styles">

            /* Inspiration from https://www.uplabs.com/collections/profile-fd2d2339-bc35-44ae-822a-983aa31fa15a */

            /* GENERAL */
            :host {
                min-height: calc(100% - 16px);
                margin: 0;
                position: absolute;
                width: 100%;
                padding-bottom: 16px;
                display: block;
                background-color: var(--app-primary-background-color);
            }

            /* TOOLBAR */
            #toggleFavoriteUserButton {
                float: right;
            }

            .reputation {
                font-size: 12px;
                padding: 4px;
                border-radius: 33px;
                background-color: var(--app-primary-text-color);
                color: var(--app-primary-color);
            }

            /* HEADER */
            #profileheader {
                background-color: var(--app-primary-color);
                background-size: cover;
                color: var(--app-primary-text-color);
                width: 100%;
                padding-top: 16px;
                margin-top: 48px;
            }

            @media (max-width: 600px) {
                #profileheader {
                    margin-top: 40px;
                }
            }

            .profileRepresentation {
                width: 124px;
                height: 124px;
                border-radius: 124px;
            }

            #topheader {
                margin: 16px auto;
                max-width: 600px;
                max-height: 600px;
            }

            .headerLeftPart {
                display: inline-block;
                height: 124px;
                margin: 16px;
            }

            @media screen and (max-width: 400px) {
                .headerRightPart {
                    margin-left: 0 !important;
                }
            }

            .headerRightPart {
                display: inline-block;
                position: absolute;
                height: 124px;
                margin: 8px;
                font-size: 16px;
            }

            .followed, .followers {
                margin-left: 32px;
                padding: 4px;
                display: inline-block;
                transition: all .2s;
            }

            .followed:active, .followers:active {
                background-color: rgba(255, 255, 255, .2);
                transition: all .2s;
            }

            .number {
                font-size: 32px;
                font-weight: bold;
                display: block;
            }

            /* TABS */
            #profileTabs {
                @apply(--shadow-elevation-2dp);
                background-color: var(--app-dark-primary-color);
                --paper-tabs-selection-bar-color: var(--app-secondary-color);
            }

            #profileTabs paper-tab {
                --paper-tab-ink: var(--app-secondary-color);
            }

            /* AFTER TABS CONTENT */
            div[name="posts"], div[name="replies"], div[name="history"], div[name="followers"], div[name="following"] {
                max-width: 600px;
                margin: 12px auto;
            }

            .nothingText {
                display: table;
                margin-left: auto;
                margin-right: auto;
                margin-top: 100px;
                color: var(--app-background-primary-text-color);
            }

            /* ABOUT */
            div[name="about"] {
                padding-top: 12px;
            }

            div[name="about"] {
                color: var(--app-background-secondary-text-color);
                max-width: 600px;
                margin: auto;
            }

            @media screen and (max-width: 600px) {
                div[name="about"] {
                   min-width: 100%;
                }
                paper-card {
                    min-width: 0px !important;
                }
            }

            div[name="about"] h2 {
                margin-bottom: 0px;
                margin-left: 8px;
            }

            .aboutValues {
                display: block;
                font-family: 'Roboto', 'Open Sans', 'Lato', sans-serif;
                padding-bottom: 4px;
            }

            .aboutValues .name {
                color: var(--app-secondary-color);
            }

            #aboutViewName {
                display: inline-block;
                vertical-align: sub;
                margin-top: 0;
                color: var(--app-background-primary-text-color);
            }

            #votingPower {
                display: inline-flex;
                vertical-align: middle;
                width: 100%;
            }

            #votingPowerBar {
                width: 100%;
                --paper-slider-disabled-knob-color: var(--app-primary-color);
                --paper-slider-disabled-secondary-color: var(--app-background-secondary-text-color);
                --paper-slider-disabled-active-color: var(--app-background-primary-text-color);
            }

            .link a {
                color: var(--app-secondary-color) !important;
            }

            .link iron-icon {
                color: var(--app-background-primary-text-color);
            }

            paper-card {
                background-color: var(--app-secondary-background-color);
                --paper-card-header-text: {
                    font-size: 18px;
                    padding-bottom: 0;
                    text-transform: uppercase;
                    font-family: 'Roboto', 'Open Sans', sans-serif;
                    color: var(--app-background-primary-text-color);
                };
                margin-top: 12px;
                margin-bottom: 12px;
                min-width: 600px;
            }

            #lastestPostList {
                max-width: 568px;
                overflow: auto;
                display: inline-flex;
            }

            paper-menu-button {
                color: var(--app-background-primary-text-color);
                margin-left: 8px;
            }

            paper-menu, paper-item {
                background-color: var(--app-secondary-background-color);
                color: var(--app-background-secondary-text-color);
            }

            .pinnedPostVotes {
                color: var(--app-background-primary-text-color);
            }

        </style>

        <steem-get-account account-name="[[_username]]"
                           account="{{_account}}">
        </steem-get-account>

        <steem-get-followers account-name="[[_username]]"
                             followers="{{_followers}}">
        </steem-get-followers>

        <steem-get-following account-name="[[_username]]"
                             following="{{_following}}">
        </steem-get-following>

        <!-- IDEA: Clip a post permlink in profile json that is display in a tabs added + clip a post dedicated to be rendered in profile about tabs -->

        <!-- TOOLBAR -->
        <paper-toolbar class="mainToolbar">

            <paper-icon-button id="toggleDrawerMenu"
                               on-tap="_openDrawer()"
                               icon="my-icons:menu">
            </paper-icon-button>

            <div class="floatingToolbar">
                <span class="floatingToolbarTitle">
                    <span>
                        [[user]]
                        <span class="reputation">[[_account.reputation]]</span>
                    </span>
                    <span></span>
                    <paper-icon-button id="toggleFavoriteUserButton"
                                       icon="my-icons:[[_computeFavoriteUserIcon(_isUserInFavorite)]]"
                                       on-tap="_toggleFavoriteUser()">
                    </paper-icon-button>
                </span>
            </div>

            <a href="/hot/">
                <paper-icon-button icon="my-icons:explore"></paper-icon-button>
            </a>

        </paper-toolbar>

        <div id="profileheader">

            <div id="topheader">

                <div class="headerLeftPart">
                    <template is="dom-if" if="[[_account.profileImage]]">
                        <iron-image class="profileRepresentation"
                                    sizing="cover"
                                    src="https://img1.steemit.com/124x124/[[_account.profileImage]]">
                        </iron-image>
                    </template>
                    <template is="dom-if" if="[[!_account.profileImage]]">
                        <iron-icon class="profileRepresentation"
                                   icon="my-icons:person-circle">
                        </iron-icon>
                    </template>
                </div>

                <div class="headerRightPart">
                    <div id="followersButton"
                         class="followers"
                         on-tap="_setCurrentViewFollowers">
                        <span class="number">
                            <template is="dom-if" if="[[_followers.length]]">
                                [[_followers.length]]
                            </template>
                            <template is="dom-if" if="[[!_followers.length]]">
                                0
                            </template>
                        </span>
                        <span class="texte">
                            Followers
                        </span>
                    </div>
                    <div id="followingButton"
                         class="followed"
                         on-tap="_setCurrentViewFollowers">
                        <span class="number">
                            <template is="dom-if" if="[[_following.length]]">
                                [[_following.length]]
                            </template>
                            <template is="dom-if" if="[[!_following.length]]">
                                0
                            </template>
                        </span>
                        <span class="texte">
                            Following
                        </span>
                    </div>
                </div>

            </div>

            <paper-tabs id="profileTabs"
                        selected="{{_currentProfileView}}"
                        attr-for-selected="name"
                        fit-container
                        scrollable
                        no-slide>
                <paper-tab name="about">
                    <iron-icon icon="my-icons:account-about"></iron-icon>
                </paper-tab>
                <paper-tab name="posts">
                    <iron-icon icon="my-icons:text-file"></iron-icon>
                </paper-tab>
                <!-- Will be released when API permit it -->
                <!--paper-tab name="comments">Comments</paper-tab-->
                <paper-tab name="replies">
                    <iron-icon icon="my-icons:message-reply-text"></iron-icon>
                </paper-tab>
                <paper-tab name="history">
                    <iron-icon icon="my-icons:history"></iron-icon>
                </paper-tab>
                <paper-tab name="followers">
                    <iron-icon icon="my-icons:follower"></iron-icon>
                </paper-tab>
                <paper-tab name="following">
                    <iron-icon icon="my-icons:following"></iron-icon>
                </paper-tab>
            </paper-tabs>

        </div>

        <!-- CONTENT -->
        <iron-pages selected="[[_currentProfileView]]"
                    attr-for-selected="name">

            <!-- ABOUT -->
            <div name="about">

                <paper-menu-button>
                    <paper-icon-button icon="menu" class="dropdown-trigger"></paper-icon-button>
                    <paper-menu id="aboutmenu" class="dropdown-content">
                        <paper-item view="home">Home</paper-item>
                        <template is="dom-if" if="[[_account.pinnedPosts]]">
                            <template is="dom-repeat" items="[[_toJson(_account.pinnedPosts)]]">
                                <paper-item view="[[item.name]]">[[_capitalizeFirstLetter(item.name)]]</paper-item>
                            </template>
                        </template>
                    </paper-menu>
                </paper-menu-button>


                <h2 id="aboutViewName">[[_capitalizeFirstLetter(_currentAboutView)]]</h2>

                <iron-pages selected="[[_currentAboutView]]"
                            attr-for-selected="name">

                    <div name="home">
                        <paper-card heading="Informations" class="homeCard">

                            <div class="card-content">
                                <template is="dom-if" if="[[_account.about.length]]">
                                    <div class="about">
                                        <p>[[_account.about]]</p>
                                    </div>
                                </template>

                                <template is="dom-if" if="[[_account.location.length]]">
                                    <div class="location">
                                        <iron-icon icon="my-icons:map"></iron-icon>
                                        <span>[[_account.location]]</span>
                                    </div>
                                </template>

                                <template is="dom-if" if="[[_account.website.length]]">
                                    <div class="link website">
                                        <iron-icon icon="my-icons:web"></iron-icon>
                                        <a target="_blank" href="[[_account.website]]">[[_computeLinkText(_account.website)]]</a>
                                    </div>
                                </template>
                                <template is="dom-if" if="[[_account.webLinks.length]]">
                                    <template is="dom-repeat" items="[[_toJson(_account.webLinks)]]">
                                        <div class="link">
                                            <iron-icon icon="my-icons:[[_computeLinkIcon(item)]]"></iron-icon>
                                            <a target="_blank" href="[[item]]">[[_computeLinkText(item)]]</a>
                                        </div>
                                    </template>
                                </template>
                            </div>
                        </paper-card>

                        <template is="dom-if" if="[[_account.customValues]]">
                            <paper-card heading="About" class="homeCard">
                                <div class="card-content">
                                    <template is="dom-repeat" items="[[_toJson(_account.customValues)]]">
                                        <div class="aboutValues">
                                            <span class="name">[[item.name]]:</span>
                                            <span class="value">&nbsp;[[item.value]]</span>
                                        </div>
                                    </template>
                                </div>
                            </paper-card>
                        </template>

                        <!--div id="votingPower">
                              <paper-slider id="votingPowerBar" disabled value="[[_account.votingPower]]"></paper-slider>
                              [[_account.votingPower]]%
                          </div-->

                        <!-- LATEST POST -->
                        <paper-card heading="Latest [[user]] publications" class="homeCard">
                            <post-path-list steem-path="[[user]]" post-type="card-light"></post-path-list>
                        </paper-card>

                        <!-- PINED POSTS (presentation) -->
                        <template is="dom-if" if="[[_account.pinnedPost]]">
                            <paper-card>
                                <post-wrapper post-type="content-minimal"
                                              post-path="[[_account.pinnedPost]]">
                                </post-wrapper>
                            </paper-card>
                        </template>
                    </div>

                    <template is="dom-if" if="[[_account.pinnedPosts]]">
                        <template is="dom-repeat" items="[[_toJson(_account.pinnedPosts)]]">
                            <div name="[[item.name]]">
                                <template is="dom-repeat" items="[[item.posts]]">
                                    <paper-card>
                                        <post-wrapper post-type="content-minimal"
                                                      post-path="[[item]]">
                                        </post-wrapper>
                                    </paper-card>
                                </template>
                            </div>
                        </template>
                    </template>

                </iron-pages>

            </div>

            <!-- POSTS -->
            <div name="posts">
                <steem-get-state path="[[user]]"
                                 posts="{{_posts}}">
                </steem-get-state>
                <div id="posts-list">

                    <template is="dom-if" if="[[!_posts.length]]">
                        <h1 class="nothingText">[[user]] has not posted anything</h1>
                    </template>

                    <template is="dom-if" if="[[_posts.length]]">
                        <template is="dom-repeat" items="[[_posts]]">
                            <post-card post="[[item]]"
                                       settings="[[settings]]">
                            </post-card>
                        </template>
                    </template>

                </div>
            </div>

            <!-- REPLIES -->
            <div name="replies">
                <steem-get-replies user-name="[[_username]]"
                                    replies="{{_replies}}">
                </steem-get-replies>
                <div id="replies-list">

                    <template is="dom-if" if="[[!_replies.length]]">
                        <h1 class="nothingText">[[user]] has no replies</h1>
                    </template>

                    <template is="dom-if" if="[[_replies.length]]">
                        <template is="dom-repeat" items="[[_replies]]">
                            <reply-card reply="[[item]]"></reply-card>
                        </template>
                    </template>

                </div>
            </div>

            <!-- REPLIES -->
            <div name="history">
                <steem-get-history id="steemGetHistory"
                                   user-name="[[_username]]"
                                   events="{{_events}}">
                </steem-get-history>
                <div id="events-list">

                    <template is="dom-if" if="[[!_events.length]]">
                        <h1 class="nothingText">[[user]] has no history</h1>
                    </template>

                    <template is="dom-if" if="[[_events.length]]">
                        <!--iron-scroll-threshold  on-lower-threshold="_loadMoreHistoryEvents"> This is triggered before _events are loaded :/-->
                        <template is="dom-repeat" items="[[_events]]">
                            <event-card event="[[item]]"></event-card>
                        </template>
                        <!--/iron-scroll-threshold-->
                    </template>

                </div>
            </div>

            <!-- FOLLOWER -->
            <div name="followers">
                <div id="followers-list">

                    <template is="dom-if" if="[[!_followers.length]]">
                        <h1 class="nothingText">[[user]] has no follower</h1>
                    </template>

                    <template is="dom-if" if="[[_followers.length]]">
                        <template is="dom-repeat" items="[[_followers]]">
                            <user-card user="[[item]]"></user-card>
                        </template>
                    </template>

                </div>
            </div>

            <!-- FOLLOWING -->
            <div name="following">
                <div id="following-list">

                    <template is="dom-if" if="[[!_following.length]]">
                        <h1 class="nothingText">[[user]] is not following anyone</h1>
                    </template>

                    <template is="dom-if" if="[[_following.length]]">
                        <template is="dom-repeat" items="[[_following]]">
                            <user-card user="[[item]]"></user-card>
                        </template>
                    </template>

                </div>
            </div>
        </iron-pages>
    </template>

    <script>

        Polymer({

            is: 'page-profile',

            properties: {

                settings: {
                    type: Object,
                    notify: true
                },

                user: {
                    type: String
                },

                _account: {
                    type: Object
                },

                _posts: {
                    type: Array
                },

                _replies: {
                    type: Array
                },

                _currentProfileView: {
                    type: String
                },

                _currentAboutView: {
                    type: String
                },

                _username: {
                    type: String,
                    notify: true
                },

                _followers: {
                    type: Array
                },

                _following: {
                    type: Array
                },

                _events: {
                    type: Array
                },

                _isUserInFavorite: {
                    type: Boolean
                },

                _isTabAbout: {
                    type: Boolean
                },

                _pinnedPost: {
                    type: Object
                }
            },

            observers: [
                '_updateCoverImage(_account.coverImage)',
                '_userChanged(user)',
                '_refreshIsTabAbout(_currentProfileView)',
                '_refreshIsTopheaderShowed(_isTabAbout)'
            ],

            listeners: {
                'aboutmenu.tap': '_selectAboutView'
            },

            ready: function() {
                // Set variables
                this._currentProfileView = 'about';
                this._currentAboutView = 'home';

                // List event
                this.$.toggleDrawerMenu.addEventListener('tap', this._openDrawer.bind(this));
                this.$.followersButton.addEventListener('tap', this._setCurrentViewFollowers.bind(this));
                this.$.followingButton.addEventListener('tap', this._setCurrentViewFollowing.bind(this));
                this.$.toggleFavoriteUserButton.addEventListener('tap', this._toggleFavoriteUser.bind(this));
            },

            _userChanged: function(user) {

                // Reset _account object

                // Remove '@' at user and put it into _username
                var user = user;
                this.set('_username', user.substring(1));
                this._refreshIsFavoriteUser();
            },

            _openDrawer: function() {

                document.getElementById('appshell')._openDrawer();
            },

            _updateCoverImage: function(url) {

                if(url !== ''){

                    this.$.profileheader.style.backgroundImage = "url('" + url + "')";
                }else {

                    this.$.profileheader.style.backgroundImage = "";
                }

            },

            _selectAboutView: function(e) {
                
                if(typeof e.path[0].view === 'undefined') {
                    
                    this._currentAboutView = "home";
                }else {

                    this._currentAboutView = e.path[0].view;
                }
            },

            _setCurrentViewFollowers: function() {

                this.set('_currentProfileView', 'followers');
            },

            _setCurrentViewFollowing: function() {

                this.set('_currentProfileView', 'following')
            },

            _setCurrentViewPosts: function() {

                this.set('_currentProfileView', 'posts');
            },

            _refreshIsFavoriteUser: function() {

                this._isUserInFavorite = document.getElementById('appshell').isFavoriteUser(this._username);
            },

            _toggleFavoriteUser: function() {

                if(this._isUserInFavorite) {

                    // Remove user from favourite
                    document.getElementById('appshell').removeFavoriteUser(this._username);
                }else {

                    // Add user to favourite
                    document.getElementById('appshell').addFavoriteUser(this._username);
                }

                // Invert favorite state of user
                this._refreshIsFavoriteUser();
            },

            _computeFavoriteUserIcon: function(userIsInFavorite) {

                return userIsInFavorite ?
                    'favorite':
                    'favorite-border';
            },

            _loadMoreHistoryEvents: function() {

                this.$.steemGetHistory.loadMoreData();
            },

            _refreshIsTabAbout: function(currentProfileView) {

                this._isTabAbout = (currentProfileView == 'about');
                //window.scrollTo(0, 0);
            },

            _getPostTitleFromPath: function(postPath) {

                var pathSplitted = postPath.split('/');
                var postTitleindex = pathSplitted.length-1;
                var postTitle = pathSplitted[postTitleindex];
                var postTitleText = postTitle.split('-').join(' ');
                    postTitleText = this._capitalizeFirstLetter(postTitleText);

                return postTitleText;
            },

            _capitalizeFirstLetter: function(string) {

                string = string.charAt(0).toUpperCase() + string.slice(1);

                return string;
            },

            _refreshIsTopheaderShowed: function(isTabAbout) {

                if(isTabAbout) {

                    this.$.topheader.style = "";//"height: auto;"//+this.$.topheader.clientHeight+";";
                }else {

                    this.$.topheader.style = "margin-top:-2px;margin-bottom:-1px;max-height: 0;display:none;transition: all 0.6s ease-out;";//transform: translateY(-600px)"; //"height: 0;margin:-1px;visibility:hidden;opacity: 0";
                }


            },

            _computeLinkIcon: function(link) {

                if(link.includes('github.com') || link.includes('github.io')) {

                    return 'github';
                }else if(link.includes('plus.google.com')) {

                    return 'google-plus';
                }else if(link.includes('twitter.com')) {

                    return 'twitter';
                }else if(link.includes('facebook.com')) {

                    return 'facebook';
                }else if(link.includes('google') && link.includes('maps')) {

                    return 'map';
                }else if(link.includes('dribbble')) {

                    return 'dribbble';
                }else if(link.includes('jira')) {

                    return 'jira';
                }else if(link.includes('slack.com')) {

                    return 'slack';
                }else if(link.includes('snapchat')) {

                    return 'snapchat';
                }else if(link.includes('soundcloud.com')) {

                    return 'soundcloud';
                }else if(link.includes('twitch.tv')) {

                    return 'twitch';
                }else if(link.includes('discordapp.com')) {

                    return 'discord';
                }else {

                    return 'link';
                }
            },

            _computeLinkText: function(link) {

                if(typeof link !== 'undefined') {

                    var link = link.replace("https://", "")
                            .replace("http://", "")
                            .replace("www.", "");

                    return link;
                }else {

                    return '';
                }
            },

            _toJson: function(text) {

                return JSON.parse(text);
            }

            /*
             * IDEAS
             * Pin post into a tab or and pin _posts into a second tab in tab about
             */

        });
    </script>
</dom-module>